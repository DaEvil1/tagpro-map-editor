<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>TagPro Map Editor</title>
		<script src="generatepng.js"></script>
		<script src="webtoolkit.base64.js"></script>
		<script src="jquery-2.1.0.min.js"></script>

<style type="text/css">
img {
	margin:1px;
}
body {
}
#ballpen {
	display:inline-block;
}
#ballpentext {
	font-family: monospace;
	z-index:3;
	width:150px;
	margin-top:-100px;
}
div.tileRow {
  height:40px;
}
div.tile {
  width:40px;
  height:40px;
  background-image: url("default-skin.png"); 
  display:inline-block;
}
div.tileBackground {
  width:40px;
  height:40px;
  background-image: url("default-skin.png"); 
  display:inline-block;
  background-position: -80px -80px;
}
div.selectionIndicator {
  width:40px;
  height:40px;
  background-image: url("selected.png"); 
  display:none;
}
</style>
</head>
<body>
<div id="ballpen"></div>
<a href='#' id='logicLink'>logic</a>
<div id='palette'>
  
</div>
<a href='#' id='toolPencil' class='toolButton'>Pencil</a>
<a href='#' id='toolBrush' class='toolButton'>Brush</a>
<a href='#' id='toolWire' class='toolButton'>Wire</a>

<div style='height:30em;overflow:scroll' id='map'>



</div>

<input type='button' value='Export!' id='export' />

<script>
$(function() {
  var tileSize = 40;
  function TileType(name, sheetX, sheetY, r,g,b, extra) {
    this.name = name;
    this.sheetX = sheetX;
    this.sheetY = sheetY;
    this.color = String.fromCharCode(r)+String.fromCharCode(g)+String.fromCharCode(b)+String.fromCharCode(255);
    this.postPlaceFn = extra&&extra.postPlaceFn;
    this.logicFn = extra&&extra.logicFn;
    this.image = extra&&extra.image;
  }
  TileType.prototype.positionCss = function() {
    return -this.sheetX*tileSize + 'px ' + -this.sheetY*tileSize + 'px';
  }
  TileType.prototype.drawOn = function($elem) {
    $elem.css('background-color', this.name == 'empty' ? 'black' : '');
    $elem.css('background-position', this.positionCss())
    $elem.css('background-image', 'url("' + (this.image || 'default-skin') + '.png")')
  }
  
  function Tool(fns) {
    this.down = fns.down || function() {};
    this.drag = fns.drag || function() {};
    this.up = fns.up || function() {};
    this.select = fns.select || function() {};
    this.unselect = fns.unselect || function() {};
  }
  var pencil = new Tool({
    drag: function(x,y) {
      tiles[x][y].setType(brushTileType);
    }
  });
  var brush = new Tool({
    drag: function(x,y) {
      for (var ix=x-1; ix<=x+1; ix++) {
        for (var iy=y-1; iy<=y+1; iy++) {
          if (ix>=0 && iy>=0 && ix<width && iy<height) {
            tiles[ix][iy].setType(brushTileType);
          }
        }
      }
    }
  });
  var wire = new Tool({
    unselect: function() {
      clearHighlights();
    },
    down: function(x,y) {
      var tile = tiles[x][y];
      if (tile.type == switchType) {
        console.log('selected a switch')
        this.selectedSwitch = tile;
        clearHighlights();
        tile.highlight(true);
        
        var sel = this.selectedSwitch.affected || ( this.selectedSwitch.affected={});
        for (var key in sel) {
          var coords = sel[key];
          tiles[coords[0]][coords[1]].highlight(true);
        }
      } else {
        if (this.selectedSwitch) {
          var affected = this.selectedSwitch.affected || ( this.selectedSwitch.affected={});
          var key = x + ',' + y;
          if (affected[key]) {
            console.log('unselected');
            delete affected[key]
            tile.highlight(false);
            console.log('unselected', affected);
          } else {
            affected[key] = [x,y];
            tile.highlight(true);
            console.log('selected', affected);
          }
        }
      }
    }
  });
  
  function clearHighlights() {
    $map.find('.selectionIndicator').css('display', 'none');
  }
  

  function ensureUnique(placedX, placedY) {
    for (var x=0; x<width; x++) {
      for (var y=0; y<height; y++) {
        if (x==placedX && y==placedY) continue;
        if (tiles[x][y].type == this) {
          tiles[x][y].setType(floorType);
        }
      }
    }
  }
  
  function setFieldFn(defaultState) {
    return function(logic, tile) {
      logic.fields[tile.x + ',' + tile.y] = {defaultState: defaultState};
    }
  }
  
  function exportSwitch(logic, tile) {
    if (tile.type == switchType) {
      var toggles = [];
      console.log(tile.affected);
      for (var key in tile.affected) {
        var coord = tile.affected[key];
        console.log(coord);
        var affectedTile = tiles[coord[0]][coord[1]];
        var t = affectedTile.type;
        console.log(affectedTile, t);
        if (t==bombType || t==onFieldType || t==offFieldType || t==redFieldType || t.type==blueFieldType) {
          toggles.push({pos: {x: affectedTile.x, y: affectedTile.y}});
          console.log(toggles);
        }
      }
      logic.switches[tile.x + ',' + tile.y] = {toggle: toggles};
    }
  }
  
  var floorType, blueFlagType, redFlagType, switchType, bombType, onFieldType, offFieldType, redFieldType, blueFieldType;
  var tileTypes = [
    floorType = new TileType('floor', 2,2, 212,212,212),
    new TileType('empty', 0,1, 0,0,0),
    new TileType('wall', 0,0, 120,120,120),
    switchType = new TileType('switch', 2,5, 185,122,87, {logicFn: exportSwitch}),
    new TileType('spike', 2,3, 55,55,55),
    bombType=new TileType('bomb', 6,5, 255,128,0),
    new TileType('powerup', 7,8, 0,255,0),
    new TileType('speedpad', 0,0, 255,255,0, {image: 'speedpad'}),
    new TileType('blueSpeedpad', 0,0, 115,115,255, {image: 'speedpadblue'}),
    new TileType('redSpeedpad', 0,0, 255,115,115, {image: 'speedpadred'}),
    new TileType('redFloor', 3,1, 220,186,186),
    new TileType('blueFloor', 3,2 , 187,184,221),
    offFieldType = new TileType('offField', 10,1, 0,117,0, {logicFn: setFieldFn('off')}),
    onFieldType = new TileType('onField', 10,2, 0,117,0, {logicFn: setFieldFn('on')}),
    redFieldType = new TileType('redField', 10,3, 0,117,0, {logicFn: setFieldFn('red')}),
    blueFieldType= new TileType('blueField', 10,4, 0,117 ,0, {logicFn: setFieldFn('blue')}),
    redFlagType = new TileType('redFlag', 8,0, 255,0,0),
    blueFlagType = new TileType('blueFlag', 9,0, 0,0,255)
  ]

  function Tile() {
    
  }
  Tile.prototype.setType = function(type) {
    if  (this.type==type) return;
    this.type = type;
    type.drawOn(this.elem);
    if (type.postPlaceFn) {
      type.postPlaceFn.call(type, this.x, this.y);
    }
  }
  Tile.prototype.highlight = function(highlighted) {
    this.elem.find('.selectionIndicator').css('display', highlighted ? 'inline-block' : 'none');
  }

  var $map = $('#map');
  var $palette = $('#palette');
  var height = 20;
  var width = 10;
  var html = '';
  var row = "<div class='tileRow'>";
  
  var brushTileType = tileTypes[0];
  
  for (var x=0; x<width; x++) {
    row += "<div class='tileBackground'><div class='tile'><div class='selectionIndicator'></div></div></div>";
  }
  row += "</div>"
  for (var y=0; y<height; y++) {
    html += row;
  }
  console.log(row)
  $map.html( html );
  
  var $tiles = $map.find('.tile');
  var tiles = [];
  
  for (var x=0; x<width; x++) {
    tiles[x] = [];
    for (var y=0; y<height; y++) {
      var $tile = $($tiles[y*width + x]).data('x', x).data('y', y);
      tiles[x][y] = new Tile();
      tiles[x][y].elem = $tile;
      tiles[x][y].type = brushTileType;
      tiles[x][y].x = x;
      tiles[x][y].y = y;
      brushTileType.drawOn($tile);
    }
  }
  
  var selectedTool = pencil;
  
  var mouseDown = false;
  $map.on('mousedown', '.tile', function(e) {
    if (event.which==1) {
      mouseDown = true;
      var x = $(this).data('x');
      var y = $(this).data('y');
      selectedTool.down.call(selectedTool, x,y);
      selectedTool.drag.call(selectedTool, x,y);
      e.preventDefault();
    }
  })
  .on('mousemove', '.tile', function() {
    if (mouseDown) {
      var x = $(this).data('x');
      var y = $(this).data('y');
      selectedTool.drag.call(selectedTool, x,y);
    }
  })
  .on('mouseup', '.tile', function() {
    if (event.which==1) {
      mouseDown = false;
    }
  });
  
  var wall = String.fromCharCode(120)+String.fromCharCode(120)+String.fromCharCode(120)+String.fromCharCode(255);
  var open = String.fromCharCode(212)+String.fromCharCode(212)+String.fromCharCode(212)+String.fromCharCode(255);
  function createPng() {
    var text = '';
    for (var y=0; y<height; y++) {
      for (var x=0; x<width; x++) {
        text += tiles[x][y].type.color;
      }
    }
    return text;
  }
  
  function makeLogic() {
    var logic = {
      info: {
        name: 'Untitled',
        author: 'Anonymous'
      },
      switches: {},
      fields: {}
    };
      
    for (var x=0; x<width; x++) {
      for (var y=0; y<height; y++) {
        var fn = tiles[x][y].type.logicFn;
        if (fn) fn(logic, tiles[x][y])
      }
    }
    console.log(logic);
    return logic;
  }
  
  $('#export').click(function() {
    console.log('exporting')
    var 
      pngData,
      pngFile,
      base64png,
      dataUrl = 'data:image/png;base64,',
      logicUrl = 'data:application/json;base64,',
      img,
      ballpen;

    pngData	= createPng();
    pngFile = generatePng(width, height, pngData);
    
    base64png = Base64.encode(pngFile);
    dataUrl += base64png;

    logicUrl += Base64.encode(JSON.stringify(makeLogic()));
    
    img = document.createElement("img");
    img.src = dataUrl;
    img.style.float = "left";
    img.style.left = "0";
    img.style.top = "0";
    img.style.zIndex = "2";
    ballpen = document.getElementById("ballpen");
    ballpen.insertBefore(img, ballpen.firstChild);
    
    $('#logicLink').attr('href', logicUrl);
  });
  
  
  $.each(tileTypes, function(idx, type) {
    var $button = $("<div class='tileBackground'><div class='tile'></div></div>");
    type.drawOn($button.find('.tile'));
    $button.click('click', function() {
      brushTileType = type;
      console.log('sel', type);
      
    });
    $palette.append($button);
  });
  
  $('#toolPencil').data('tool', pencil);
  $('#toolBrush').data('tool', brush);
  $('#toolWire').data('tool', wire);
  $('.toolButton').click(function() {
    selectedTool.unselect.call(selectedTool)
    selectedTool = $(this).data('tool');
    selectedTool.select.call(selectedTool);
  })
});
</script>
</body></html>